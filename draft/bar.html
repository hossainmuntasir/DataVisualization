<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demographic Bar Chart</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .bar { fill: steelblue; }
        .bar:hover { fill: orange; }
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
    </style>
</head>
<body>
<div class="chart-container">
    <div>
        <label for="year-select">Year:</label>
        <select id="year-select"></select>
        <label for="country-select">Country:</label>
        <select id="country-select"></select>
        <div id="my_dataviz"></div>
    </div>
</div>

<script>
// Set the dimensions and margins of the graph
const margin = { top: 20, right: 30, bottom: 80, left: 50 },
      width = 1060 - margin.left - margin.right,
      height = 600 - margin.top - margin.bottom;

// Append the svg object to the body of the page
const svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Read the data and create the chart
d3.csv("\\Line/data.csv").then(function(data) {
    // Extract years and countries for the dropdown
    const years = Array.from(new Set(data.map(d => d.year))).sort();
    const countries = Array.from(new Set(data.map(d => d.country))).sort();

    d3.select("#year-select").selectAll("option")
      .data(years).enter()
      .append("option")
      .text(d => d);

    d3.select("#country-select").selectAll("option")
      .data(countries).enter()
      .append("option")
      .text(d => d);

    updateChart(years[0], countries[0]); // Initial chart for default selections

    d3.select("#year-select").on("change", function() {
        updateChart(this.value, d3.select("#country-select").property("value"));
    });

    d3.select("#country-select").on("change", function() {
        updateChart(d3.select("#year-select").property("value"), this.value);
    });

    function updateChart(selectedYear, selectedCountry) {
        // Filter data based on selections
        const filteredData = data.filter(d => d.year === selectedYear && d.country === selectedCountry);

        // Map the data to the categories and values for males and females
        const categories = ['Females-at-birth', 'Males-at-birth', 'Females-at-age-40', 'Males-at-age-40',
                            'Females-at-age-60', 'Males-at-age-60', 'Females-at-age-65', 'Males-at-age-65',
                            'Females-at-age-80', 'Males-at-age-80'];
        const groupedData = categories.map(category => ({
            category,
            value: parseFloat(filteredData[0][category.split('-')[1] + '-at-' + category.split('-')[2]])
        }));

        // X scale
        const x = d3.scaleBand()
          .range([0, width])
          .domain(groupedData.map(d => d.category))
          .padding(0.2);

        svg.append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

        // Add Y axis
        const y = d3.scaleLinear()
          .domain([0, d3.max(groupedData, d => d.value)])
          .range([height, 0]);

        svg.append("g")
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .data(groupedData)
          .enter()
          .append("rect")
            .attr("x", d => x(d.category))
            .attr("y", d => y(d.value))
            .attr("width", x.bandwidth())
            .attr("height", d => height - y(d.value))
            .attr("fill", "#69b3a2");
    }
});
</script>
</body>
</html>
